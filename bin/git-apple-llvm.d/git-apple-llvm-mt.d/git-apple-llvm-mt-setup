#!/bin/bash

. "$(dirname $0)"/../helpers/init.sh

APPLE_LLVM_MT_CONFIG="$APPLE_LLVM_BIN_DIR/../mt-config"
print_repos() { find "$APPLE_LLVM_MT_CONFIG" -type f | xargs cat; }

run() {
    echo "$*" >&2
    "$@" || exit 1
}

mt_setup() {
    [ -d repo ] ||
        run git init --bare repo
    print_repos | {
        local forks= sleepnext=0
        while read name url; do
            # Wait a second if the previous iteration needed a fresh clone.
            sleep $sleepnext
            [ -d "$clone" ]
            sleep_next=$?

            clone=repo/clones/$name.git
            if [ -d "$clone" ]; then
                run git -C $clone remote update
            else
                run mkdir -p $(dirname $clone)
                run git clone --mirror $url $clone
                run git -C repo remote add $name $PWD/$clone
            fi &
            forks="$forks $!"
        done
        wait $forks
    } &&
    run git -C repo fetch --no-tags --all
}

mt_setup
